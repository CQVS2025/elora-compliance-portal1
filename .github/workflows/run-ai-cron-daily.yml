name: AI Insights Daily Cron

on:
  schedule:
    # 6:00 AM Adelaide = 19:30 UTC
    - cron: '30 19 * * *'
  workflow_dispatch:  # Allow manual run from Actions tab

jobs:
  run-ai-cron:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Trigger run-ai-cron Edge Function
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/run-ai-cron" \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -d '{}' \
            --max-time 600)
          HTTP_BODY=$(echo "$RESPONSE" | head -n -1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $HTTP_BODY"
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Success"
          else
            echo "❌ Failed (HTTP $HTTP_CODE)"
            exit 1
          fi
