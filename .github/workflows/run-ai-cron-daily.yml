name: AI Insights Daily Cron

on:
  schedule:
    # 6:00 AM Adelaide = 19:30 UTC
    - cron: '30 19 * * *'
  workflow_dispatch:  # Allow manual run from Actions tab

jobs:
  run-ai-cron:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Increased timeout for Node.js backend
    steps:
      - name: Trigger AI Insights Cron via Node.js API
        run: |
          echo "Calling: ${{ secrets.APP_URL }}/api/cron/ai-insights"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.APP_URL }}/api/cron/ai-insights" \
            -H "Content-Type: application/json" \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -d '{}' \
            --max-time 1800)
          HTTP_BODY=$(echo "$RESPONSE" | head -n -1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $HTTP_BODY"
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Success"
          else
            echo "❌ Failed (HTTP $HTTP_CODE)"
            exit 1
          fi
